<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cognizer-1 Minimal Test</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 30px;
    }

    button {
      padding: 20px 40px;
      font-size: 18px;
      font-weight: 600;
      border: 2px solid #fff;
      background: transparent;
      color: #fff;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      min-width: 150px;
    }

    button:hover {
      background: #fff;
      color: #000;
    }

    button:active {
      transform: scale(0.98);
    }

    #controls {
      display: none;
      gap: 20px;
      flex-direction: column;
      align-items: center;
    }
    
    #buttons {
      display: flex;
      gap: 20px;
    }
    
    #readouts {
      display: flex;
      gap: 20px;
      font-size: 14px;
    }
    
    .percept-readout {
      width: 300px;
      height: 120px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.7);
      overflow: hidden;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #state {
      font-size: 24px;
      font-weight: 300;
      letter-spacing: 2px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #state.visible {
      opacity: 1;
    }

    #state.cognizing {
      color: #f59e0b;
      animation: pulse 1s infinite;
    }

    #state.visualizing {
      color: #a78bfa;
      animation: pulse 1s infinite;
    }

    #state.ready {
      color: #22c55e;
    }

    #mindMoment {
      width: 600px;
      font-size: 16px;
      line-height: 1.6;
      text-align: center;
      color: #fff;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    #sigilPhrase {
      font-size: 14px;
      color: #f59e0b;
      opacity: 0.8;
      margin-bottom: 20px;
      font-style: italic;
      min-height: 20px;
    }

    #sigilContainer {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #sigilContainer.visible {
      display: flex;
    }

    #sigilCanvas {
      width: 200px;
      height: 200px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
    }

    #sigilLabel {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #kineticReadout, #lightingReadout {
      width: 300px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 14px;
      margin-top: 10px;
    }

    #kineticReadout {
      border-left: 3px solid #a78bfa;
    }

    #lightingReadout {
      border-left: 3px solid #f59e0b;
    }

    .readout-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }

    .readout-value {
      font-size: 16px;
      color: #fff;
      font-weight: 600;
    }

    .color-swatch {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      vertical-align: middle;
      margin-left: 8px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body>
  <button id="toggle">START</button>
  
  <div id="controls">
    <div id="buttons">
      <button id="visual">VISUAL</button>
      <button id="audio">AUDIO</button>
    </div>
    <div id="readouts">
      <div id="visualReadout" class="percept-readout">-</div>
      <div id="audioReadout" class="percept-readout">-</div>
    </div>
  </div>
  
  <div id="state">READY</div>
  
  <div id="mindMoment"></div>
  <div id="sigilPhrase"></div>

  <div id="sigilContainer">
    <canvas id="sigilCanvas" width="100" height="100"></canvas>
    <div id="sigilLabel">Sigil</div>
  </div>

  <div id="kineticReadout">
    <div class="readout-label">Kinetic</div>
    <div class="readout-value" id="kineticValue">-</div>
  </div>

  <div id="lightingReadout">
    <div class="readout-label">Lighting</div>
    <div class="readout-value" id="lightingValue">-</div>
  </div>

  <script>
    const SOCKET_URL = 'http://localhost:3001';
    // const SOCKET_URL = 'http://uni-cognizer-1-production.up.railway.app';
    const SESSION_ID = 'minimal-session-' + Date.now();
    
    let socket = null;
    let isRunning = false;
    
    const toggleBtn = document.getElementById('toggle');
    const controlsDiv = document.getElementById('controls');
    const visualBtn = document.getElementById('visual');
    const audioBtn = document.getElementById('audio');
    const stateDiv = document.getElementById('state');
    const mindMomentDiv = document.getElementById('mindMoment');
    const sigilPhraseDiv = document.getElementById('sigilPhrase');
    const sigilContainer = document.getElementById('sigilContainer');
    const sigilCanvas = document.getElementById('sigilCanvas');
    const visualReadout = document.getElementById('visualReadout');
    const audioReadout = document.getElementById('audioReadout');
    const kineticValue = document.getElementById('kineticValue');
    const lightingValue = document.getElementById('lightingValue');
    
    let typewriterTimeout = null;
    let typewriterAborted = false;
    
    // Mock percepts - will be loaded from JSON files
    let mockVisual = [];
    let mockAudio = [];
    
    async function loadMockPercepts() {
      try {
        const visualResponse = await fetch('../data/mock-visual-percepts-visitor.json');
        const audioResponse = await fetch('../data/mock-audio-percepts-detailed.json');
        
        mockVisual = await visualResponse.json();
        mockAudio = await audioResponse.json();
        
        console.log(`‚úÖ Loaded ${mockVisual.length} visual percepts`);
        console.log(`‚úÖ Loaded ${mockAudio.length} audio percepts`);
      } catch (error) {
        console.error('‚ùå Failed to load mock percepts:', error);
        // Fallback to basic percepts if loading fails
        mockVisual = [
          { action: "Looking up", emoji: "‚¨ÜÔ∏è", weight: 1 },
          { action: "Waving", emoji: "üëã", weight: 1 },
          { action: "Pointing at screen", emoji: "üëâ", weight: 1 }
        ];
        mockAudio = [
          { transcript: "Hello, UNI", emoji: "üëã", weight: 1 },
          { transcript: "What can you do?", emoji: "‚ùì", weight: 1 },
          { transcript: "This is amazing", emoji: "ü§©", weight: 1 }
        ];
      }
    }
    
    function randomPick(array) {
      return array[Math.floor(Math.random() * array.length)];
    }
    
    function weightedRandom(items) {
      if (!items || items.length === 0) return null;
      
      // If items don't have weights, pick randomly
      if (!items[0].weight) {
        return randomPick(items);
      }
      
      const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
      let random = Math.random() * totalWeight;
      
      for (const item of items) {
        random -= item.weight;
        if (random <= 0) return item;
      }
      
      return items[0]; // Fallback
    }
    
    function typewriterEffect(text, element, delay = 5) {
      // Abort any existing typewriter
      if (typewriterTimeout) {
        clearTimeout(typewriterTimeout);
        typewriterTimeout = null;
      }
      
      // Clear element and reset
      element.textContent = '';
      typewriterAborted = false;
      
      let index = 0;
      
      function typeNextChar() {
        if (typewriterAborted) return;
        
        if (index < text.length) {
          element.textContent += text.charAt(index);
          index++;
          typewriterTimeout = setTimeout(typeNextChar, delay);
        } else {
          typewriterTimeout = null;
        }
      }
      
      typeNextChar();
    }
    
    function abortTypewriter() {
      typewriterAborted = true;
      if (typewriterTimeout) {
        clearTimeout(typewriterTimeout);
        typewriterTimeout = null;
      }
    }
    
    function renderSigil(code) {
      const ctx = sigilCanvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, 100, 100);
      
      // Set up drawing style
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // Validate code before executing
      if (!code || typeof code !== 'string' || code.trim().length === 0) {
        console.error('‚ùå Invalid sigil code: empty or not a string');
        drawErrorIndicator(ctx);
        return;
      }
      
      // Check for dangerous patterns
      if (code.includes('eval(') || code.includes('Function(') || code.includes('import') || code.includes('require')) {
        console.error('‚ùå Sigil code contains dangerous patterns');
        drawErrorIndicator(ctx);
        return;
      }
      
      // Execute the sigil code
      try {
        eval(code);
        console.log('‚úÖ Sigil rendered successfully');
      } catch (error) {
        console.error('‚ùå Failed to render sigil:', error);
        console.error('   Code:', code.substring(0, 100) + '...');
        drawErrorIndicator(ctx);
      }
    }
    
    function drawErrorIndicator(ctx) {
      // Draw error indicator (red X)
      ctx.strokeStyle = '#f87171';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(20, 20);
      ctx.lineTo(80, 80);
      ctx.moveTo(80, 20);
      ctx.lineTo(20, 80);
      ctx.stroke();
    }
    
    function start() {
      isRunning = true;
      toggleBtn.textContent = 'STOP';
      controlsDiv.style.display = 'flex';
      stateDiv.classList.add('visible');
      
      // Connect to Cognizer-1
      socket = io(SOCKET_URL);
      
      socket.on('connect', () => {
        console.log('‚úÖ Connected to Cognizer-1');
        socket.emit('startSession', { sessionId: SESSION_ID });
      });
      
      socket.on('sessionStarted', ({ sessionId }) => {
        console.log('üìù Session started:', sessionId);
      });
      
      socket.on('cognitiveState', ({ state }) => {
        console.log('üß† State:', state);
        stateDiv.textContent = state;
        stateDiv.className = state.toLowerCase() + ' visible';
      });
      
      socket.on('mindMoment', (data) => {
        console.log('üí≠ Mind moment:', data.mindMoment);
        console.log('‚ú® Sigil phrase:', data.sigilPhrase);
        console.log('üèÉ Kinetic:', data.kinetic);
        console.log('üí° Lighting:', data.lighting);
        
        // Abort any in-progress typewriter and display new mind moment
        abortTypewriter();
        typewriterEffect(data.mindMoment, mindMomentDiv);
        
        // Display sigil phrase
        if (data.sigilPhrase) {
          sigilPhraseDiv.textContent = `"${data.sigilPhrase}"`;
          sigilPhraseDiv.classList.add('fade-in');
        } else {
          sigilPhraseDiv.textContent = '';
        }
        
        // Display kinetic data
        if (data.kinetic) {
          kineticValue.textContent = data.kinetic.pattern;
        }
        
        // Display lighting data
        if (data.lighting) {
          const color = data.lighting.color.replace('0x', '#');
          const swatch = `<span class="color-swatch" style="background-color: ${color};"></span>`;
          lightingValue.innerHTML = `${data.lighting.pattern} (${data.lighting.speed.toFixed(1)}) ${swatch}`;
        }
      });
      
      socket.on('sigil', (data) => {
        console.log('üé® Sigil code received for cycle:', data.cycle);
        console.log('   Phrase:', data.sigilPhrase);
        console.log('   Code length:', data.sigilCode?.length || 0);
        
        // Render sigil on canvas
        if (data.sigilCode) {
          renderSigil(data.sigilCode);
          sigilContainer.classList.add('visible', 'fade-in');
        }
      });
      
      socket.on('disconnect', () => {
        console.log('üîå Disconnected');
      });
    }
    
    function stop() {
      isRunning = false;
      toggleBtn.textContent = 'START';
      controlsDiv.style.display = 'none';
      stateDiv.classList.remove('visible');
      
      // Clear mind moment display
      abortTypewriter();
      mindMomentDiv.textContent = '';
      sigilPhraseDiv.textContent = '';
      
      // Clear sigil display
      sigilContainer.classList.remove('visible');
      const ctx = sigilCanvas.getContext('2d');
      ctx.clearRect(0, 0, 100, 100);
      
      // Clear kinetic and lighting readouts
      kineticValue.textContent = '-';
      lightingValue.textContent = '-';
      
      // Clear readouts
      visualReadout.textContent = '-';
      audioReadout.textContent = '-';
      
      if (socket) {
        socket.emit('endSession', { sessionId: SESSION_ID });
        socket.disconnect();
        socket = null;
      }
    }
    
    function sendVisual() {
      if (!socket || !isRunning) return;
      
      const percept = weightedRandom(mockVisual);
      if (!percept) return;
      
      socket.emit('percept', {
        sessionId: SESSION_ID,
        type: 'visual',
        data: percept
      });
      
      visualReadout.textContent = `${percept.emoji} ${percept.action}`;
      console.log('üëÅÔ∏è Sent visual:', percept);
    }
    
    function sendAudio() {
      if (!socket || !isRunning) return;
      
      const percept = weightedRandom(mockAudio);
      if (!percept) return;
      
      socket.emit('percept', {
        sessionId: SESSION_ID,
        type: 'audio',
        data: percept
      });
      
      const display = percept.transcript 
        ? `${percept.emoji} "${percept.transcript}"` 
        : `${percept.emoji} ${percept.analysis}`;
      audioReadout.textContent = display;
      console.log('üé§ Sent audio:', percept);
    }
    
    // Event listeners
    toggleBtn.addEventListener('click', () => {
      if (isRunning) {
        stop();
      } else {
        start();
      }
    });
    
    visualBtn.addEventListener('click', sendVisual);
    audioBtn.addEventListener('click', sendAudio);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (socket && isRunning) {
        socket.emit('endSession', { sessionId: SESSION_ID });
        socket.disconnect();
      }
    });
    
    // Initialize - load mock percepts
    loadMockPercepts();
  </script>
</body>
</html>

