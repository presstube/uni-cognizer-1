<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognizer-1 Test Host</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            font-size: 14px;
            font-weight: 500;
        }

        .status::before {
            content: '‚óè';
            margin-right: 8px;
            font-size: 16px;
        }

        .status.connected::before {
            color: #4ade80;
        }

        .status.disconnected::before {
            color: #f87171;
        }

        section {
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
        }

        section:last-child {
            border-bottom: none;
        }

        h3 {
            color: #374151;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #startBtn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        #endBtn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .percepts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .percepts h3 {
            grid-column: 1 / -1;
        }

        .percept-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .percept-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            min-height: 56px;
            height: 56px;
        }

        .percept-readout {
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            min-height: 100px;
            height: 100px;
            font-size: 13px;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            overflow-y: auto;
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .percept-readout em {
            font-style: italic;
        }

        .percept-readout .emoji {
            font-size: 20px;
            margin-right: 8px;
        }

        .percept-readout .text {
            color: #374151;
            font-weight: 500;
        }

        .mind-moment-card {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            padding: 20px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mind-moment-card em {
            color: #6b7280;
            font-style: italic;
        }

        .cycle {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .moment {
            font-size: 18px;
            color: #1f2937;
            font-weight: 500;
            line-height: 1.5;
        }

        .sigil {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
        }

        .time {
            font-size: 12px;
            color: #9ca3af;
        }

        .stats {
            background: #f9fafb;
        }

        #stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        #stats p {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #stats span {
            display: block;
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-top: 8px;
        }

        .history-item {
            background: #f9fafb;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #e5e7eb;
            transform: translateX(4px);
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-item strong {
            color: #667eea;
            font-weight: 600;
        }

        #history:empty::after {
            content: 'No history yet...';
            color: #9ca3af;
            font-style: italic;
            display: block;
            text-align: center;
            padding: 20px;
        }

        .details {
            background: #f9fafb;
        }

        .details-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #374151;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .details-content em {
            color: #9ca3af;
            font-style: italic;
        }

        .details-section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .details-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .details-label {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
        }

        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
            }

            #stats {
                grid-template-columns: 1fr;
            }

            .percepts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† Cognizer-1 Test Host</h1>
            <div id="status" class="status disconnected">‚óè Disconnected</div>
        </header>

        <section class="controls">
            <button id="startBtn">‚ñ∂Ô∏è Start Session</button>
            <button id="endBtn" disabled>‚è∏Ô∏è End Session</button>
        </section>

        <section class="percepts">
            <h3>Send Percepts</h3>
            <div class="percept-column">
                <button class="percept-btn" data-type="visual" disabled>üëÅÔ∏è Visual</button>
                <div id="visualReadout" class="percept-readout">
                    <em>No visual percept sent yet</em>
                </div>
            </div>
            <div class="percept-column">
                <button class="percept-btn" data-type="audio" disabled>üé§ Audio</button>
                <div id="audioReadout" class="percept-readout">
                    <em>No audio percept sent yet</em>
                </div>
            </div>
        </section>

        <section class="output">
            <h3>Latest Mind Moment</h3>
            <div id="mindMoment" class="mind-moment-card">
                <em>Waiting for mind moment...</em>
            </div>
        </section>

        <section class="stats">
            <h3>Session Stats</h3>
            <div id="stats">
                <p>Duration<span id="duration">--</span></p>
                <p>Percepts Sent<span id="perceptCount">0</span></p>
                <p>Mind Moments<span id="momentCount">0</span></p>
            </div>
        </section>

        <section class="history">
            <h3>History (last 5)</h3>
            <div id="history"></div>
        </section>

        <section class="details">
            <h3>Mind Moment Details</h3>
            <div id="details" class="details-content">
                <em>Click on a history item to see details...</em>
            </div>
        </section>
    </div>

    <script>
        // Configuration
        const SOCKET_URL = 'http://localhost:3001';
        const SESSION_ID = 'test-session-' + Date.now();
        
        // Socket connection
        const socket = io(SOCKET_URL);
        
        // State
        let sessionActive = false;
        let sessionStartTime = null;
        let perceptCount = 0;
        let momentCount = 0;
        let durationInterval = null;
        let history = [];
        
        // Mock percepts - loaded from data files
        let MOCK_VISUAL_PERCEPTS = [];
        let MOCK_AUDIO_PERCEPTS = [];
        
        // Load mock percepts from data files
        async function loadMockPercepts() {
            try {
                const visualResponse = await fetch('../data/mock-visual-percepts-visitor.json');
                const audioResponse = await fetch('../data/mock-audio-percepts-detailed.json');
                
                MOCK_VISUAL_PERCEPTS = await visualResponse.json();
                MOCK_AUDIO_PERCEPTS = await audioResponse.json();
                
                console.log(`‚úÖ Loaded ${MOCK_VISUAL_PERCEPTS.length} visual percepts`);
                console.log(`‚úÖ Loaded ${MOCK_AUDIO_PERCEPTS.length} audio percepts`);
            } catch (error) {
                console.error('‚ùå Failed to load mock percepts:', error);
                // Fallback to basic percepts if loading fails
                MOCK_VISUAL_PERCEPTS = [
                    { action: "Visitor approaching", emoji: "üö∂", weight: 1 },
                    { action: "Looking up at ceiling", emoji: "‚¨ÜÔ∏è", weight: 1 },
                    { action: "Taking photo", emoji: "üì±", weight: 1 }
                ];
                MOCK_AUDIO_PERCEPTS = [
                    { 
                        transcript: "Wow, this is amazing!",
                        analysis: "Visitor expressing wonder",
                        tone: "Enthusiastic",
                        emoji: "üòÆ",
                        sentiment: "positive",
                        confidence: 0.9,
                        weight: 1
                    }
                ];
            }
        }
        
        // Weighted random selection (matches fake-percepts.js logic)
        function weightedRandom(items) {
            const totalWeight = items.reduce((sum, p) => sum + (p.weight || 1), 0);
            let random = Math.random() * totalWeight;
            
            for (const item of items) {
                random -= (item.weight || 1);
                if (random <= 0) return item;
            }
            return items[0];
        }
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('‚úÖ Connected to Cognizer-1');
            updateStatus('connected');
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from Cognizer-1');
            updateStatus('disconnected');
            if (sessionActive) {
                sessionActive = false;
                stopDurationTimer();
                updateControls();
            }
        });
        
        socket.on('sessionStarted', (data) => {
            console.log('‚ñ∂Ô∏è Session started:', data);
            sessionActive = true;
            sessionStartTime = Date.now();
            startDurationTimer();
            updateControls();
        });
        
        socket.on('mindMoment', (data) => {
            console.log('üß† Mind moment received:', data);
            displayMindMoment(data);
            addToHistory(data);
            momentCount++;
            updateStats();
        });
        
        socket.on('sessionEnded', (data) => {
            console.log('‚è∏Ô∏è Session ended:', data);
            sessionActive = false;
            stopDurationTimer();
            updateControls();
        });
        
        socket.on('sessionTimeout', (data) => {
            if (data.sessionId === SESSION_ID) {
                console.log('‚è∞ Session timed out due to inactivity');
                sessionActive = false;
                stopDurationTimer();
                updateControls();
                alert('Session timed out due to inactivity. Please start a new session.');
            }
        });
        
        socket.on('pong', (data) => {
            if (!data.valid && sessionActive && data.sessionId === SESSION_ID) {
                console.error('‚ö†Ô∏è Session no longer valid on server');
                sessionActive = false;
                stopDurationTimer();
                updateControls();
                alert('Session is no longer valid. Please start a new session.');
            }
        });
        
        socket.on('error', (error) => {
            console.error('‚ö†Ô∏è Socket error:', error);
            alert('Error: ' + error.message);
        });
        
        // UI Functions
        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            if (status === 'connected') {
                statusEl.textContent = '‚óè Connected';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = '‚óè Disconnected';
                statusEl.className = 'status disconnected';
            }
        }
        
        function updateControls() {
            document.getElementById('startBtn').disabled = sessionActive;
            document.getElementById('endBtn').disabled = !sessionActive;
            document.querySelectorAll('.percept-btn').forEach(btn => {
                btn.disabled = !sessionActive;
            });
        }
        
        function displayMindMoment(data) {
            const { cycle, mindMoment, sigilPhrase, timestamp } = data;
            const time = new Date(timestamp).toLocaleTimeString();
            
            document.getElementById('mindMoment').innerHTML = `
                <div class="cycle">Cycle #${cycle}</div>
                <div class="moment">üß† ${mindMoment}</div>
                <div class="sigil">üîÆ ${sigilPhrase}</div>
                <div class="time">üïê ${time}</div>
            `;
        }
        
        function addToHistory(data) {
            // Prevent duplicates - check if this cycle is already in history
            if (history.length > 0 && history[0].cycle === data.cycle) {
                console.log('‚ö†Ô∏è Duplicate mind moment for cycle', data.cycle, '- skipping');
                return;
            }
            
            history.unshift(data);
            if (history.length > 5) history.pop();
            
            const historyHTML = history.map((h, index) => `
                <div class="history-item" onclick="showDetails(${index})">
                    <strong>Cycle ${h.cycle}</strong>: ${h.sigilPhrase}
                </div>
            `).join('');
            
            document.getElementById('history').innerHTML = historyHTML;
        }
        
        function showDetails(index) {
            const data = history[index];
            if (!data) return;
            
            const activeVisual = (data.visualPercepts || []).filter(p => p.action !== "NOPE");
            const activeAudio = (data.audioPercepts || []).filter(p => 
                p.transcript || (p.analysis !== "Silence" && p.analysis !== "Silence - visitor observing quietly")
            );
            
            let details = '';
            
            details += `<div class="details-section">`;
            details += `<div class="details-label">CYCLE #${data.cycle}</div>`;
            details += `Time: ${new Date(data.timestamp).toLocaleString()}\n`;
            details += `</div>`;
            
            details += `<div class="details-section">`;
            details += `<div class="details-label">MIND MOMENT</div>`;
            details += `${data.mindMoment}\n`;
            details += `</div>`;
            
            details += `<div class="details-section">`;
            details += `<div class="details-label">SIGIL PHRASE</div>`;
            details += `${data.sigilPhrase}\n`;
            details += `</div>`;
            
            details += `<div class="details-section">`;
            details += `<div class="details-label">VISUAL PERCEPTS (${activeVisual.length})</div>`;
            if (activeVisual.length > 0) {
                activeVisual.forEach(p => {
                    details += `${p.emoji} ${p.action}\n`;
                });
            } else {
                details += `(none)\n`;
            }
            details += `</div>`;
            
            details += `<div class="details-section">`;
            details += `<div class="details-label">AUDIO PERCEPTS (${activeAudio.length})</div>`;
            if (activeAudio.length > 0) {
                activeAudio.forEach(p => {
                    if (p.transcript) {
                        details += `${p.emoji} "${p.transcript}"\n`;
                    } else {
                        details += `${p.emoji} ${p.analysis}\n`;
                    }
                });
            } else {
                details += `(none)\n`;
            }
            details += `</div>`;
            
            if (data.priorMoments && data.priorMoments.length > 0) {
                details += `<div class="details-section">`;
                details += `<div class="details-label">PRIOR CONTEXT (${data.priorMoments.length} moments)</div>`;
                data.priorMoments.forEach((m, i) => {
                    details += `${i + 1} cycles ago: "${m.mindMoment}"\n`;
                });
                details += `</div>`;
            }
            
            document.getElementById('details').innerHTML = details;
        }
        
        function updateStats() {
            document.getElementById('perceptCount').textContent = perceptCount;
            document.getElementById('momentCount').textContent = momentCount;
        }
        
        function startDurationTimer() {
            durationInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('duration').textContent = 
                    `${minutes}m ${seconds}s`;
            }, 1000);
        }
        
        function stopDurationTimer() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }
        
        function sendPercept(type) {
            const data = type === 'visual' 
                ? weightedRandom(MOCK_VISUAL_PERCEPTS)
                : weightedRandom(MOCK_AUDIO_PERCEPTS);
            
            socket.emit('percept', {
                sessionId: SESSION_ID,
                type: type,
                data: data,
                timestamp: new Date().toISOString()
            });
            
            perceptCount++;
            updateStats();
            updatePerceptReadout(type, data);
            console.log(`üì§ Sent ${type} percept:`, data);
        }
        
        function updatePerceptReadout(type, data) {
            const readoutId = type === 'visual' ? 'visualReadout' : 'audioReadout';
            const readoutEl = document.getElementById(readoutId);
            
            if (type === 'visual') {
                readoutEl.innerHTML = `
                    <span class="emoji">${data.emoji}</span>
                    <span class="text">${data.action}</span>
                `;
            } else {
                readoutEl.innerHTML = `
                    <span class="emoji">${data.emoji}</span>
                    <div class="text">"${data.transcript}"</div>
                `;
            }
        }
        
        // Button handlers
        document.getElementById('startBtn').addEventListener('click', () => {
            socket.emit('startSession', { sessionId: SESSION_ID });
            perceptCount = 0;
            momentCount = 0;
            history = [];
            document.getElementById('history').innerHTML = '';
            updateStats();
            console.log('‚ñ∂Ô∏è Starting session:', SESSION_ID);
        });
        
        document.getElementById('endBtn').addEventListener('click', () => {
            socket.emit('endSession', { sessionId: SESSION_ID });
            console.log('‚è∏Ô∏è Ending session:', SESSION_ID);
        });
        
        document.querySelectorAll('.percept-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                sendPercept(type);
            });
        });
        
        // Initialize
        async function init() {
            await loadMockPercepts();
            updateControls();
            console.log('üöÄ Cognizer-1 Test Host initialized');
            console.log('üì° Connecting to:', SOCKET_URL);
            
            // Set up session health check
            setInterval(() => {
                if (sessionActive) {
                    socket.emit('ping', { sessionId: SESSION_ID });
                }
            }, 15000); // Ping every 15 seconds
        }
        
        // Handle page unload - end session gracefully
        window.addEventListener('beforeunload', (e) => {
            if (sessionActive) {
                console.log('üö™ Page unloading, ending session...');
                socket.emit('endSession', { sessionId: SESSION_ID });
                // Give socket a moment to send (synchronous doesn't guarantee delivery)
                // Browser will handle cleanup
            }
        });
        
        init();
    </script>
</body>
</html>

