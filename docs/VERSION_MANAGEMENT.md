# Version Management Guide

## How Cognizer Version Tracking Works

Cognizer uses **semantic versioning** (semver) to track changes and ensure reproducibility of mind moments. Every mind moment is tagged with the exact Cognizer version that generated it.

---

## Version Format

```
MAJOR.MINOR.PATCH
  â”‚     â”‚     â”‚
  â”‚     â”‚     â””â”€â”€â”€ Bug fixes, small tweaks (0.1.0 â†’ 0.1.1)
  â”‚     â””â”€â”€â”€â”€â”€â”€â”€ New features, backward compatible (0.1.0 â†’ 0.2.0)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Breaking changes (0.1.0 â†’ 1.0.0)
```

**Examples:**
- `0.1.0` â†’ `0.1.1`: Fixed sigil generation bug
- `0.1.0` â†’ `0.2.0`: Added personality system
- `0.9.0` â†’ `1.0.0`: Changed WebSocket API structure

---

## When to Bump the Version

### PATCH Version (0.1.0 â†’ 0.1.1)
**Bump for:**
- Bug fixes that don't change behavior
- Performance improvements
- Internal refactoring
- Documentation updates
- Dependency updates

**Examples:**
- Fixed database connection timeout
- Improved error messages
- Optimized sigil generation speed

### MINOR Version (0.1.0 â†’ 0.2.0)
**Bump for:**
- New features (backward compatible)
- New API endpoints
- New configuration options
- Enhanced existing features

**Examples:**
- Added personality management API
- Added version query endpoints
- Added new kinetic patterns
- Enhanced prior context depth

### MAJOR Version (0.9.0 â†’ 1.0.0)
**Bump for:**
- Breaking changes to API
- Database schema changes requiring migration
- Changed WebSocket event structure
- Removed deprecated features

**Examples:**
- Changed mind moment JSON structure
- Renamed WebSocket events
- Required new environment variables

---

## How to Bump the Version

### Step 1: Update package.json

```bash
# Manual edit
vim package.json
# Change: "version": "0.1.0" â†’ "version": "0.2.0"

# OR use npm (recommended)
npm version patch   # 0.1.0 â†’ 0.1.1
npm version minor   # 0.1.0 â†’ 0.2.0
npm version major   # 0.9.0 â†’ 1.0.0
```

`npm version` automatically:
- Updates `package.json`
- Creates a git commit
- Creates a git tag

### Step 2: Register in Database

```bash
# Register without notes (auto-generated message)
npm run version:register

# OR with release notes
npm run version:register -- --notes "Added personality management system"
```

This:
- Reads version from `package.json`
- Inserts into `cognizer_versions` table
- Timestamps the release
- Stores your notes

### Step 3: Deploy

```bash
# Deploy to production
git push origin main

# Railway/Render will automatically:
# 1. Pull new code
# 2. Run migrations (npm run migrate)
# 3. Start server (npm start)
```

**Note:** Version registration happens **after deployment** when you manually run `npm run version:register` on production, or you can add it to your deploy script.

---

## Version Tracking in Action

### Every Mind Moment is Tagged

```javascript
// In real-cog.js
await saveMindMoment({
  cycle: 42,
  mindMoment: "I notice someone waving...",
  cognizerVersion: "0.2.0",  // â† Automatically included
  llmProvider: "gemini",
  // ... other fields
});
```

### Query Mind Moments by Version

```javascript
// Future API endpoint (Phase 3)
GET /api/mind-moments?version=0.2.0

// Returns all moments generated by v0.2.0
```

### Version History

```sql
-- See all versions deployed
SELECT * FROM cognizer_versions ORDER BY released_at DESC;

-- Results:
-- version | released_at              | notes
-- --------|--------------------------|---------------------------
-- 0.2.0   | 2025-11-20 14:30:00      | Added personality system
-- 0.1.1   | 2025-11-18 09:15:00      | Fixed sigil bug
-- 0.1.0   | 2025-11-13 12:00:00      | Initial release
```

---

## Practical Workflow

### Daily Development

```bash
# You're working on features...
# No version bump needed yet

# Test locally
npm run client:fake
```

### Before Deployment

```bash
# 1. Decide version bump
#    New feature? â†’ minor (0.1.0 â†’ 0.2.0)
#    Bug fix? â†’ patch (0.1.0 â†’ 0.1.1)

# 2. Bump version (creates git commit + tag)
npm version minor -m "Add personality management"

# 3. Push to remote
git push origin main --follow-tags

# 4. Deploy happens automatically (Railway/Render)
```

### After Deployment

```bash
# 5. Register version in production database
# (Run this on your local with production DATABASE_URL, or SSH to production)

npm run version:register -- --notes "Added personality management system"

# Or let the migration script handle it (already includes 0.1.0)
```

---

## Checking Your Current Version

```bash
# Quick check
npm run version:check
# Output: Current version: 0.1.0

# Full details
node -p "require('./package.json').version"
# Output: 0.1.0

# Check what version the running server has
# (It logs on startup)
npm start
# Output: ğŸ“¦ Cognizer v0.1.0 (Node v20.10.0)
```

---

## Why Version Tracking Matters

### 1. **Reproducibility**
"Why did UNI say that?" â†’ Check which version generated it
- Version 0.1.0 had shorter context (2 moments)
- Version 0.2.0 has longer context (3 moments)

### 2. **A/B Testing**
Compare behavior across versions:
```sql
-- Compare mind moment sentiment by version
SELECT cognizer_version, COUNT(*), AVG(LENGTH(mind_moment))
FROM mind_moments
GROUP BY cognizer_version;
```

### 3. **Debugging**
"This bug only happens in production" â†’ Check version mismatch
```bash
# Local
npm run version:check  # 0.2.0

# Production
# Check logs: ğŸ“¦ Cognizer v0.1.0
# Aha! Production is behind!
```

### 4. **Analytics**
Track improvements over time:
- Processing speed per version
- Sigil generation success rate
- Context depth effectiveness

---

## Database Schema

```sql
-- Version registry
CREATE TABLE cognizer_versions (
  version VARCHAR(20) PRIMARY KEY,       -- "0.2.0"
  released_at TIMESTAMP DEFAULT NOW(),   -- When deployed
  notes TEXT                              -- Release notes
);

-- Mind moments reference versions
CREATE TABLE mind_moments (
  -- ... other fields
  cognizer_version VARCHAR(20),
  FOREIGN KEY (cognizer_version) REFERENCES cognizer_versions(version)
);

-- Fast queries by version
CREATE INDEX idx_mind_moments_version ON mind_moments(cognizer_version);
```

---

## Automatic Version Insertion

Your migration already registers `0.1.0`:

```sql
-- In 001_initial_schema.sql
INSERT INTO cognizer_versions (version, notes)
VALUES ('0.1.0', 'Initial schema - Phase 1 implementation')
ON CONFLICT (version) DO NOTHING;
```

For future versions, use `npm run version:register`.

---

## Example: Full Version Bump Workflow

Let's say you just added the personality system:

```bash
# 1. âœ… Code is done, tested locally
npm run client:fake  # Works great!

# 2. ğŸ·ï¸ Bump version (new feature = minor)
npm version minor -m "feat: Add personality management system"
# Updates: 0.1.0 â†’ 0.2.0
# Creates: git commit + tag v0.2.0

# 3. ğŸ“¤ Push to production
git push origin main --follow-tags

# 4. ğŸš€ Deploy happens automatically
# Railway detects new commit, rebuilds, deploys

# 5. ğŸ“Š Register version in production DB
# (After deploy is live)
npm run version:register -- --notes "Added personality management system with REST API and dynamic loading"

# Output:
# âœ… Version registered successfully!
#    Version: 0.2.0
#    Released: 2025-11-17T20:30:15.123Z
#    Notes: Added personality management system...

# 6. âœ… Done! New version is tracked
```

---

## Quick Reference

| Command | Purpose |
|---------|---------|
| `npm version patch` | Bug fix: 0.1.0 â†’ 0.1.1 |
| `npm version minor` | New feature: 0.1.0 â†’ 0.2.0 |
| `npm version major` | Breaking change: 0.9.0 â†’ 1.0.0 |
| `npm run version:register` | Register in database |
| `npm run version:check` | Check current version |

---

## Next Steps

Now that version tracking is complete, every mind moment UNI generates will be tagged with the exact Cognizer version. This enables:

- Historical analysis ("How has UNI evolved?")
- Behavior debugging ("Which version caused this?")
- Feature impact assessment ("Did v0.2.0 improve responses?")
- Rollback safety (restore old version if needed)

**Your version tracking is now production-ready!** ğŸ‰

---

**See also:**
- `package.json` - Source of truth for version
- `src/version.js` - Exports `COGNIZER_VERSION`
- `scripts/register-version.js` - Registration script
- `src/db/migrations/001_initial_schema.sql` - Schema definition

